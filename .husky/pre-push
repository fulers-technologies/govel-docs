#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get the current branch name
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ Current branch: $current_branch"

# Prevent pushing to main/master branch directly
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âŒ Direct push to $current_branch branch is not allowed!"
  echo "ğŸ’¡ Please create a feature branch and submit a pull request."
  echo ""
  echo "ğŸ”§ To create a feature branch:"
  echo "   git checkout -b feature/your-feature-name"
  echo "   git push -u origin feature/your-feature-name"
  echo ""
  exit 1
fi

# Run comprehensive tests
echo "ğŸ§ª Running comprehensive test suite..."

# Run TypeScript type checking
echo "ğŸ” Running TypeScript type checking..."
if command -v pnpm >/dev/null 2>&1; then
  if ! pnpm run type-check; then
    echo "âŒ TypeScript type checking failed. Please fix the type errors before pushing."
    exit 1
  fi
fi

# Run Go tests with coverage
if command -v go >/dev/null 2>&1; then
  echo "ğŸ¹ Running Go tests with coverage..."
  if ! go test -v -race -coverprofile=coverage.out ./...; then
    echo "âŒ Go tests failed. Please fix the failing tests before pushing."
    exit 1
  fi
  
  # Check test coverage
  coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
  if [ -n "$coverage" ]; then
    echo "ğŸ“Š Test coverage: $coverage%"
    # You can set a minimum coverage threshold here
    # if (( $(echo "$coverage < 80" | bc -l) )); then
    #   echo "âŒ Test coverage is below 80%. Current: $coverage%"
    #   exit 1
    # fi
  fi
fi

# Run linting
echo "ğŸ” Running linting checks..."
if ! pnpm run lint:all; then
  echo "âŒ Linting failed. Please fix the issues before pushing."
  exit 1
fi

# Check for TODO/FIXME comments in staged files
echo "ğŸ“ Checking for TODO/FIXME comments..."
todo_count=$(git diff origin/$current_branch..HEAD --name-only | xargs grep -l -i -E "(TODO|FIXME|XXX|HACK)" 2>/dev/null | wc -l)
if [ $todo_count -gt 0 ]; then
  echo "âš ï¸  Warning: Found $todo_count file(s) with TODO/FIXME comments:"
  git diff origin/$current_branch..HEAD --name-only | xargs grep -n -i -E "(TODO|FIXME|XXX|HACK)" 2>/dev/null || true
  echo ""
  echo "ğŸ’¡ Consider addressing these before pushing to maintain code quality."
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check for console.log/print statements (basic check)
echo "ğŸ–¨ï¸  Checking for debug statements..."
debug_count=$(git diff origin/$current_branch..HEAD --name-only | xargs grep -l -i -E "(console\.log|print\(|fmt\.Print)" 2>/dev/null | wc -l)
if [ $debug_count -gt 0 ]; then
  echo "âš ï¸  Warning: Found $debug_count file(s) with potential debug statements:"
  git diff origin/$current_branch..HEAD --name-only | xargs grep -n -i -E "(console\.log|print\(|fmt\.Print)" 2>/dev/null || true
  echo ""
  echo "ğŸ’¡ Consider removing debug statements before pushing."
  read -p "Continue anyway? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check if package.json and pnpm-lock.yaml are in sync
if [ -f "package.json" ] && [ -f "pnpm-lock.yaml" ]; then
  echo "ğŸ“¦ Checking package.json and pnpm-lock.yaml sync..."
  if ! pnpm install --frozen-lockfile --dry-run >/dev/null 2>&1; then
    echo "âŒ package.json and pnpm-lock.yaml are out of sync!"
    echo "ğŸ’¡ Run 'pnpm install' to fix this issue."
    exit 1
  fi
fi

# Check for merge conflicts markers
echo "ğŸ”€ Checking for merge conflict markers..."
if git diff origin/$current_branch..HEAD --name-only | xargs grep -l -E "(<<<<<<<|=======|>>>>>>>)" 2>/dev/null; then
  echo "âŒ Merge conflict markers found in files:"
  git diff origin/$current_branch..HEAD --name-only | xargs grep -n -E "(<<<<<<<|=======|>>>>>>>)" 2>/dev/null
  echo "ğŸ’¡ Please resolve merge conflicts before pushing."
  exit 1
fi

echo "âœ… All pre-push checks passed! ğŸ‰"

